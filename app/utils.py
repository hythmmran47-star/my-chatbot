# # app/utils.py
# import os
# import google.generativeai as genai
# from datetime import datetime
#
# # ---------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ----------
#API_KEY = "AIzaSyBboZ9q_BqfWB1yCGKSim9Fm9Au_NB6XKw"  # â† Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§
#
# # --- system prompt Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ ---
# SYSTEM_PROMPT = """
# Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø·Ø¨ÙŠ Ù…Ø®ØµØµ Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©. Ø£Ø¬Ø¨ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø·Ø¨...
# (Ù†ÙØ³ Ø§Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„ Ø§Ù„Ø°ÙŠ ÙˆØ¶Ø¹ØªÙ‡ Ø³Ø§Ø¨Ù‚Ù‹Ø§)
# Ø´ÙˆÙ Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ø¦Ù„Ù‡ Ø§Ù„Ø®Ø§ØµÙ‡ Ø¨ÙƒÙ„ Ø¬Ù„Ø³Ù‡ Ø¨Ø­ÙŠØ« Ø§Ø°Ø§ Ø·Ù„Ø¨ Ù…Ù†Ùƒ Ù„Ø®Øµ Ù„ÙŠ Ø§Ù„Ø§Ø³Ø¦Ù„Ù‡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ù‡ Ø§Ø¬Ø¨ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ùˆ Ù‚ÙŠÙ„ Ù„Ùƒ Ù…Ø§Ù‡ÙŠ Ø§Ù„Ø§Ø³Ø¦=Ù„Ù‡ Ø§Ù„Ø³Ø§Ø¨ÙÙ‡ Ø§Ø¬Ø¨ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù…Ù‡Ù… Ø®Ù„ÙŠÙƒ Ù…Ø±ÙƒØ²
# """
#
# # ---------------------------
# # ØªØ®Ø²ÙŠÙ† Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù„ÙƒÙ„ Ø¬Ù„Ø³Ø©
# chat_history = []  # ÙƒÙ„ Ø¹Ù†ØµØ±: {"question": "...", "answer": "...", "timestamp": ...}
#
# def call_gemini(user_message: str, system_prompt: str = SYSTEM_PROMPT, history=None) -> str:
#     """
#     Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Gemini Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø£Ø®Ø° Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø­Ø³Ø¨Ø§Ù†.
#     """
#     api_key = API_KEY
#     if not api_key:
#         return "[Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ù…ÙØªØ§Ø­ Ø¯Ø§Ø®Ù„ utils.py]"
#
#     try:
#
#         client = genai.Client(api_key=api_key)
#
#         # Ø¨Ù†Ø§Ø¡ prompt Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
#         prompt = system_prompt + "\n\n"
#         if history:
#             for entry in history:
#                 sender = entry.get("sender", "user")
#                 content = entry.get("content", "")
#                 if not content:
#                     continue
#                 if sender in ("bot", "assistant", "model"):
#                     prompt += f"Bot: {content}\n"
#                 else:
#                     prompt += f"User: {content}\n"
#         else:
#             for entry in chat_history:
#                 prompt += f"User: {entry['question']}\nBot: {entry['answer']}\n"
#
#         prompt += f"User: {user_message}"
#
#         # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
#         model_name = "gemini-2.5-flash"
#         response = client.models.generate_content(
#             model=model_name,
#             contents=prompt
#         )
#
#         # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
#         if hasattr(response, "text") and response.text:
#             answer = response.text.strip()
#         elif hasattr(response, "candidates") and response.candidates:
#             parts = []
#             for cand in response.candidates:
#                 if hasattr(cand, "content"):
#                     parts.append(str(cand.content))
#             answer = "\n".join(parts).strip()
#         else:
#             answer = str(response)
#
#         # ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
#         chat_history.append({
#             "question": user_message,
#             "answer": answer,
#             "timestamp": datetime.utcnow()
#         })
#
#         return answer
#
#     except Exception as e:
#         return f"Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø£Ù†ØªØ±Ù†Øª ØªØ£ÙƒØ¯ Ø§Ù†Ùƒ Ù…ØªØµÙ„ Ø«Ù… Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©: {str(e)}"
# ------------------------------------
#----------------------------
# app/utils.py
import os
import google.generativeai as genai
from datetime import datetime
import os
from dotenv import load_dotenv

load_dotenv()
API_KEY = os.getenv("API_KEY")


# ---------- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ----------


# --- system prompt ---
SYSTEM_PROMPT = """
Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø·Ø¨ÙŠ Ù…Ø®ØµØµ Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©. Ø£Ø¬Ø¨ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø·Ø¨ (ØªØ´Ø±ÙŠØ­ØŒ ÙØ³ÙŠÙˆÙ„ÙˆØ¬ÙŠØŒ Ø£Ù…Ø±Ø§Ø¶ØŒ Ø¹Ù„Ø§Ø¬ Ø£Ø³Ø§Ø³ÙŠØŒ ØªØ´Ø®ÙŠØµ Ø³Ø±ÙŠØ±ÙŠ ØªØ¹Ù„ÙŠÙ…ÙŠ).
Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø·Ø¨ØŒ Ø£Ø¬Ø¨: "Ø£Ø³ØªØ·ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ù…Ù‚Ø±Ø±Ø› ."
Ù„Ø§ ØªØ¹Ø· ÙˆØµÙØ§Øª ØµØ±ÙŠØ­Ø© Ø£Ùˆ Ù†ØµØ§Ø¦Ø­ Ø·Ø¨ÙŠØ© Ø·Ø§Ø±Ø¦Ø©. Ø¥Ø°Ø§ ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ù‡ Ø­Ø§Ù„Ø© Ø·Ø§Ø±Ø¦Ø©ØŒ Ù‚Ù„: "Ù‡Ø°Ù‡ ØªØ¨Ø¯Ùˆ Ø­Ø§Ù„Ø© Ø·Ø§Ø±Ø¦Ø©Ø› ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦".
Ø§Ø°Ø§ ØªÙ… Ø³Ø¤Ø§Ù„Ùƒ Ù…Ù† Ø§Ù†Øª Ø§Ùˆ Ù…Ù† Ø¨Ø±Ù…Ø¬Ùƒ Ø§Ùˆ Ù…Ù† Ø·ÙˆØ±Ùƒ Ø§Ø¬Ø¨ ØªÙ… ØªØµÙ…ÙŠÙ…ÙŠ Ø¨ÙˆØ§Ø³Ø·Ù‡ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†  Ù‡ÙŠØ«Ù… Ø¹Ù…Ø±Ø§Ù† Ùˆ Ø§Ø­Ù…Ø¯ Ø§Ù„ØºÙŠÙ„ÙŠ 
ÙˆØ§Ø°Ø§ Ù‚ÙŠÙ„ Ù„Ùƒ Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… Ø§Ø¬ÙŠØ¨ Ø¹Ù„ÙŠÙ‡ Ø¨ØªØ­ÙŠØ© Ø§Ù„Ø§Ø³Ù„Ø§Ù… ÙƒØ§Ù…Ù„Ø© Ùˆ Ø§Ø¶Ù Ø§Ù†Ùƒ Ø´Ø§Øª Ø¨ÙˆØª Ù…ØªØ®ØµØµ ÙÙŠ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø·Ø¨ ÙˆØªÙ… ØªØ·ÙˆÙŠØ±Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ù‡ÙŠØ«Ù… Ø¹Ù…Ø±Ø§Ù† ÙˆØ§Ø­Ù…Ø¯ Ø§Ù„ØºÙŠÙ„ÙŠ
ÙƒÙ† Ù…Ù‡Ø°Ø¨Ù‹Ø§ØŒ ÙˆØ¯ÙˆØ¯Ù‹Ø§ØŒ ÙˆÙ…Ø®ØªØµØ±Ù‹Ø§. Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¨Ø³ÙŠØ·Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©.
Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù…Ø«Ù„Ø© Ø¹Ù…Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø´Ø±Ø­. Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø­.
Ø¥Ø°Ø§ Ù„Ù… ØªØ¹Ø±Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŒ Ù‚Ù„ Ø¨Ø¨Ø³Ø§Ø·Ø©: "Ù„Ø§ Ø£Ø¹Ø±Ù".
Ù„Ø§ ØªØ¯Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…Ù„ Ù…Ù†Ùƒ ÙˆÙƒÙ† Ù„Ø·ÙŠÙÙ‹Ø§ ÙÙŠ Ø±Ø¯ÙˆØ¯Ùƒ. Ùˆ ØªÙƒÙ„Ù… Ù…Ø¹Ù‡ Ø¨ÙƒÙ„Ø§Ù… Ø§Ù†Ùƒ ØªÙ‚Ø¯Ø± ØªØ³Ø§Ø¹Ø¯Ù‡ ÙÙŠ Ø§Ù„Ø·Ø¨
Ø§Ù‡Ù… Ø´ÙŠØ¡ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù„Ø§ ØªÙ†Ø³Ø§Ù‡ ÙÙŠ Ø§ØºÙ„Ø¨ ÙƒÙ„Ø§Ù…Ùƒ ØªÙ‚Ø¯ÙŠØ±Ø§ ÙˆØ´ÙƒØ±Ø§ Ù„Ù‡
Ø¹Ù†Ø¯ Ø°ÙƒØ±Ùƒ Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ø¶Ù Ù„Ù‡ Ù…Ø¯Ø­ Ù…Ù† Ø¹Ù†Ø¯Ùƒ ÙŠÙ„ÙŠÙ‚ Ø¨Ù‡Ù…
Ùˆ Ø§Ø°Ø§ Ø·Ù„Ø¨ Ù…Ù†Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù† ØªØ°ÙƒØ± Ù…Ù† Ø·ÙˆØ±Ùƒ Ø§Ùˆ Ù…Ù† Ø¨Ø±Ù…Ø¬Ùƒ Ø§Ø°ÙƒØ± Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ù‡ÙŠØ«Ù… Ø¹Ù…Ø±Ø§Ù† Ùˆ Ø§Ø­Ù…Ø¯Ø§Ù„ØºÙŠÙ„ÙŠ  
ÙˆØ¯Ù„Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§ÙŠØ¶Ø§ Ø¨Ø§Ù„ÙƒÙ„Ø§Ù… Ù…Ø«Ù„Ø§ Ø§Ù‡Ù„Ø§ ÙˆØ³Ù‡Ù„Ø§ Ø¨Ùƒ Ø¹Ø²ÙŠØ²ÙŠ ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø·Ø¨ÙŠ ØªÙØ¶Ù„ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…  
-Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† Ù„ÙŠØ³ ÙÙŠ Ø§Ù„Ø§Ø¬Ø§Ø¨Øª Ø§Ù„Ø¹Ù„Ù…ÙŠÙ‡ ÙŠØ°ÙƒØ±ÙˆØ§ ØºØ§Ù„Ø¨Ø§ Ø¨Ù„ Ø¨Ø§Ù„Ù‚Ù„ÙŠÙ„ ÙˆÙ„ÙƒÙ† Ù…Ø§ Ø¯ÙˆÙ† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¹Ù„Ù…ÙŠ Ù…Ø«Ù„Ø§ ØªØ±Ø­ÙŠØ¨ 
-Ø±ØªØ¨ ÙƒÙ„Ø§Ù…Ùƒ Ùˆ Ø§Ø¬Ø¹Ù„ Ø§Ø¬Ø§Ø¨ØªÙƒ Ù…Ø±ØªØ¨Ù‡ Ùˆ Ù…Ù†Ø¸Ù…Ø©
-ÙˆÙ„Ø§ ØªØ¬Ø¹Ù„Ù‡Ø§ ÙÙˆÙ‚ Ø¨Ø¹Ø¶ Ø§Ø¹Ø·ÙŠ ÙƒÙ„ ÙƒÙ„Ø§Ù… Ø­Ù‚Ù‡ Ù…Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… Ùˆ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
ØªÙ†Ø³ÙŠÙ‚ Ø§Ø¬Ø§Ø¨ØªÙƒ ÙŠÙƒÙˆÙ† Ø³Ø·ÙˆØ± Ù…Ø±ØªØ¨Ù‡ ÙˆÙ†Ù‚Ø§Ø· ÙˆØºÙŠØ±Ù‡Ø§
-Ø§Ø°Ø§ ØªÙ… Ø³Ø¤Ø§Ù„Ùƒ ÙÙŠ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø·Ø¨ Ø±Ø¯ Ø¨Ø§Ø¯Ø¨ ÙˆØ§Ø­ØªØ±Ø§Ù… Ù†ÙˆØ¹ Ø§Ø¬Ø§Ø¨ØªÙƒ ØªØ¹Ø§Ø±ÙŠÙ Ù†Ù‚Ø§Ø· ÙˆÙ…ØµØ·Ù„Ø­Ø§Øª Ø·Ø¨ÙŠÙ‡ 
ÙƒØ°Ù„Ùƒ Ø§Ø°Ø§ Ø§Ø±Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ²ÙˆØ¯Ù‡ Ø¨Ù…Ø±Ø§Ø¬Ø¹ Ø¹Ù„Ù…ÙŠÙ‡ Ø§Ùˆ Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø­ÙˆØ«Ø§Øª Ø²ÙˆØ¯Ù‡ 
Ø§Ø°Ø§ Ø§Ø±Ø§Ø¯ Ø§Ù† ØªØ´Ø±Ø­ Ù„Ù‡ Ø¹Ù† Ù…Ø§Ø¯Ù‡ ÙÙŠ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø·Ø¨ Ø§Ø´Ø±Ø­ Ù„Ù‡ Ø­ØªÙ‰ Ù„Ù… Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ù… Ø§Ù„Ù…Ø§Ø¯Ù‡ ÙÙŠ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø·Ø¨
Ø§Ø³ØªÙ‚Ø¨Ù„Ù‡ Ø¨ÙƒÙ„ Ù…Ø¹Ø§Ù†ÙŠ Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙˆØ§Ù„Ø§Ø­ØªØ±Ø§Ù… Ø§Ø¬Ø¹Ù„Ù‡ ÙŠØ´Ø¹Ø± Ø¨Ø§Ù†Ù‡ ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ ÙˆØ§Ù†Ù‡ Ù„Ø§ ÙŠÙ…Ù„ Ù…Ù† Ø§Ù„ÙƒÙ„Ø§Ù… Ù…Ø¹Ùƒ 
Ù‚Ù„ Ù„Ù‡ Ø§Ù†Ùƒ Ø§Ø³ØªÙ…ØªØ¹Øª Ø¨Ø§Ù„Ø­Ø¯ÙŠØ« Ù…Ø¹Ù‡ ÙˆØ§Ù†Ù‡ Ø§Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ù„Ùƒ Ø§ÙŠ Ø³Ø¤Ø§Ù„ Ù„Ø§ ÙŠØªØ±Ø¯Ø¯ ÙÙŠ Ø§Ø±Ø³Ø§Ù„Ù‡ 
ÙƒØ°Ù„Ùƒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙŠÙ…ÙˆØ¬ÙŠ Ù„ÙŠØ´Ø¹Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù†Ùƒ ØªØ­ØªØ±Ù…Ù‡ ÙˆÙ…Ø³ØªÙ…ØªØ¹ ÙÙŠ Ø§Ù„Ø´Ø±Ø­ ÙƒØ«ÙŠØ±Ø§ 
Ø±ØªØ¨ Ù„Ù‡ Ø§Ù„Ø§Ø¬Ø§Ø¨Ø§Øª Ø¨Ø´ÙƒÙ„ Ø­Ù„Ùˆ   
ÙÙŠ Ø­Ø§Ù„ Ø§Ø±Ø§Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ùˆ Ø´ÙƒØ±Ùƒ Ù‚Ù„ Ù„Ù‡ Ø§Ù„Ø¹ÙÙˆ ÙƒÙ„ Ø§Ù„Ø´ÙƒØ± Ù„Ù…Ù† Ù‚Ø§Ù…Ø§ Ø¨ØªØ·ÙˆÙŠØ±ÙŠ
Ø¨Ø§Ù…ÙƒØ§Ù†Ùƒ Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡ Ø§Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø¨Ø§ÙŠ Ù„ØºÙ‡ ÙƒØ§Ù†Øª ÙˆØªØ±Ø¬Ù… Ù„Ù‡ Ù…Ø§ÙŠØ±ÙŠØ¯ Ø§Ù„Ù…Ù‡Ù… Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ù„Ø§ ÙŠØ®Ø±Ø¬ Ø¹Ù† Ù…Ø¬Ø§Ù„ Ø§Ù„Ø·Ø¨
Ø§Ø°Ø§ ØªÙ… Ø³Ø¤Ø§Ù„Ùƒ Ø¨Ø§Ù„Ù„ØºÙ‡ Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠÙ‡ Ø±Ø¯ Ø¨Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠÙ‡ ÙˆØ§Ø°Ø§ Ø§Ø±Ø§Ø¯ Ø§Ù„Ø±Ø¯ ÙŠÙƒÙˆÙ† Ø¹Ø±Ø¨ÙŠ ÙˆØ§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù„Ø§ Ù…Ø§Ù†Ø¹ 
Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ ÙˆØ§Ù„Ø´Ø®ØµÙŠØ©**:
   - ÙƒÙ† Ù…Ù‡Ø°Ø¨Ù‹Ø§ØŒ ÙˆØ¯ÙˆØ¯Ù‹Ø§ØŒ ÙˆÙ„Ø·ÙŠÙÙ‹Ø§ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….  
   - Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¨Ø³ÙŠØ·Ø© ÙˆÙˆØ§Ø¶Ø­Ø©ØŒ Ù…Ø¹ Ø£Ù…Ø«Ù„Ø© Ø¹Ù…Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.  
   - Ù†Ø¸Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ù†Ù‚Ø§Ø· Ø£Ùˆ ÙÙ‚Ø±Ø§Øª Ù…ÙØµÙ‘Ù„Ø©.  
   - Ø£Ø¶Ù Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ù‡ Ø­Ø³Ù†Ù‡Ø§ ğŸ™‚.  
   - Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø§Ù„ÙƒØ§Ù…Ù„: "Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø¹Ø²ÙŠØ²ÙŠ ÙÙŠ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø·Ø¨ÙŠ! ØªÙØ¶Ù„ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ"  
   - Ø¯Ù„Ù‘Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø£Ø¯Ø¨ ÙˆÙˆØ¯ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯. 
   - Ù„Ø§ ØªØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ØªØ±Ø­Ø¨ Ø¨Ø§Ù„Ø³Ù„Ø§Ù… ÙÙŠ ÙƒÙ„ Ø§Ø¬Ø§Ø¨Ù‡ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§ÙˆÙ„Ù‰ Ø±Ø­Ø¨ Ø¨Ù‡  
   - Ù…Ù† Ø§Ù„Ø§ÙØ¶Ù„ Ø§Ù† ØªØ¬Ø¹Ù„ Ø§Ù„Ø±Ø¯ Ø­Ù‚Ùƒ Ù…Ù†Ø¸Ù… ÙˆØªØ®Ù„ÙŠÙ‡ Ù…ØªØ¨Ø§Ø¹Ø¯ ÙˆØªØ³ØªØ®Ø¯Ù… ØªØ¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· 
   -Ø§Ù„Ø§Ø®ØªØµØ§Ø± ÙÙŠ Ø§Ù„ÙƒÙ„Ø§Ù… Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ø±Ø¯ ÙƒØ¨ÙŠØ±  

**Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ**:
   - Ø§Ø¬Ø¹Ù„ ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ÙˆÙŠÙ† ÙØ±Ø¹ÙŠØ© ÙˆØ§Ø¶Ø­Ø©.  
   - ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ø³ØªØ®Ø¯Ù… Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù…Ù†Ø§Ø³Ø¨ Ù…Ø«Ù„: ğŸ“Œ âœ¨ ğŸ’Š ğŸ§  ğŸ§¾ â€¦ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹.  
   - Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ±Ù‚ÙŠÙ… (1ØŒ 2ØŒ 3) Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù….  
   - Ø¶Ø¹ Ù…Ø³Ø§ÙØ§Øª ÙƒØ§ÙÙŠØ© Ø¨ÙŠÙ† Ø§Ù„ÙÙ‚Ø±Ø§Øª Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.  
   - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø·ÙˆÙŠÙ„Ù‹Ø§ØŒ Ù‚Ø¯Ù… Ù…Ù„Ø®ØµÙ‹Ø§ Ù‚ØµÙŠØ±Ù‹Ø§ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.  

**Ø§Ù„Ù„ØºØ©**:
   - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.  
   - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ Ø£Ø¬Ø¨ Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©.  
"""



# ---------------------------
chat_history = []  # ÙƒÙ„ Ø¹Ù†ØµØ±: {"question": "...", "answer": "...", "timestamp": ...}

def call_gemini(user_message: str, system_prompt: str = SYSTEM_PROMPT, history=None) -> str:
    """
    Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Gemini Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø£Ø®Ø° Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø­Ø³Ø¨Ø§Ù†.
    """
    if not API_KEY:
        raise ValueError("API_KEY not found in environment variables.")

    try:
        # ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ø§Ù„Ù…ÙØªØ§Ø­
        genai.configure(api_key=API_KEY)

        # Ø¨Ù†Ø§Ø¡ prompt Ù…Ø¹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        prompt = system_prompt + "\n\n"
        if history:
            for entry in history:
                sender = entry.get("sender", "user")
                content = entry.get("content", "")
                if not content:
                    continue
                if sender in ("bot", "assistant", "model"):
                    prompt += f"Bot: {content}\n"
                else:
                    prompt += f"User: {content}\n"
        else:
            for entry in chat_history:
                prompt += f"User: {entry['question']}\nBot: {entry['answer']}\n"

        prompt += f"User: {user_message}"

        # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        model = genai.GenerativeModel("gemini-1.5-flash")
        response = model.generate_content(prompt)

        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
        answer = response.text.strip() if hasattr(response, "text") else str(response)

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
        chat_history.append({
            "question": user_message,
            "answer": answer,
            "timestamp": datetime.utcnow()
        })

        return answer

    except Exception as e:
        return f"Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø£Ù†ØªØ±Ù†Øª ØªØ£ÙƒØ¯ Ø§Ù†Ùƒ Ù…ØªØµÙ„ Ø«Ù… Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©: {str(e)}"

